<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>onlyfallout.com — Fallout Vertical Timeline</title>
  <meta name="description" content="A vertical, searchable Fallout timeline (1900–3000) with images, factions, and game filters." />
  <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#0b0f19" />
  <style>
    :root{
      --bg: #0b0f19;          /* page background */
      --panel: #0f172a;       /* cards & popup */
      --text: #e5e7eb;        /* primary text */
      --muted: #94a3b8;       /* muted text */
      --accent: #22d3ee;      /* ui accents */
      --pre: #f59e0b;         /* pre‑war lane color (amber) */
      --post:#10b981;         /* post‑war lane color (emerald) */
      --blue: #93c5fd;        /* pastel blue for thumb frame */
      --ring: rgba(34,211,238,.28);
      --lane-w: 10px;         /* width of the left lane */
      --legend-w: 120px;      /* legend width */
      --gutter-l: 120px;      /* base gutter */
      --thumb: 84px;          /* thumbnail size (≤100px) */
      --radius: 16px;
      --shadow: 0 20px 40px rgba(2,6,23,.45), 0 0 0 1px rgba(148,163,184,.10) inset;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    /* Toolbar */
    .toolbar{position:sticky;top:0;z-index:50;background:rgba(11,15,25,.85);backdrop-filter: blur(8px);border-bottom:1px solid rgba(148,163,184,.12)}
    .bar{max-width:1200px;margin:0 auto;padding:10px 16px;display:grid;grid-template-columns: auto 1fr auto;gap:12px;align-items:center}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .mark{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#38bdf8);display:grid;place-items:center;box-shadow:var(--shadow)}

    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .group{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .group .label{color:var(--muted);font-size:12px}
    .checkbox{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(148,163,184,.2);padding:6px 10px;border-radius:999px;background:#0e1628;color:var(--text);font-size:13px}
    .checkbox input{accent-color:var(--accent)}

    .search{display:flex;align-items:center;gap:8px;border:1px solid rgba(148,163,184,.2);padding:8px 10px;border-radius:12px;background:#0e1628;color:var(--text);min-width:220px}
    .search input{all:unset;width:220px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.2);background:#0e1628;color:var(--text)}
    .count{color:var(--muted);font-size:13px;text-align:right}

    /* Layout */
    .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns: var(--legend-w) 1fr;gap:8px}

    /* Legend */
    .legend{position:sticky;top:62px;left:0;width:var(--legend-w);color:var(--muted);font-size:12px;padding:8px 8px 0 16px}
    .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .legend .swatch{width:12px;height:12px;border-radius:3px}

    /* Timeline canvas */
    .stage-wrap{position:relative;padding-right:8px}
    .stage{position:relative; margin-left: calc(var(--gutter-l) - 40px);}
    /* move timeline a bit more to the left than before */

    .lane{position:absolute;left:calc(var(--gutter-l) - var(--lane-w) - 56px);width:var(--lane-w);border-radius:999px;overflow:hidden}
    .seg{width:100%}

    .tick{position:absolute;left:calc(var(--gutter-l) - 56px);right:12px;height:1px;background:rgba(148,163,184,.12)}
    .tick .label{position:absolute;left:calc(-100% - 16px);top:-8px;color:var(--muted);font-size:11px;white-space:nowrap}

    .event{position:absolute;display:flex;align-items:center;gap:12px;transform:translateY(-50%)}

    /* Blue-ish thumbnail frame */
    .thumb-wrap{width:calc(var(--thumb) + 10px);height:calc(var(--thumb) + 10px);padding:5px;border-radius:999px;background:rgba(147,197,253,.15);box-shadow:0 8px 24px rgba(30,58,138,.35);border:1px solid rgba(147,197,253,.35)}
    .thumb{width:var(--thumb);height:var(--thumb);border-radius:999px;object-fit:cover;border:2px solid rgba(147,197,253,.6);display:block}
    .thumb.fallback{display:grid;place-items:center;background:#111a2d;color:#7dd3fc;font-weight:700;font-size:22px}

    .meta .edate{font-size:12px;color:var(--muted)}

    /* Anchored Popup Card */
    .card{position:absolute;left:0;top:0;transform:translateY(-50%);background:var(--panel);border:1px solid rgba(148,163,184,.12);border-radius:16px;box-shadow:var(--shadow);padding:12px;min-width:min(52vw,520px);max-width:min(60vw,640px);z-index:5}
    .card .title{margin:6px 0 0;font-size:18px;font-weight:700}
    .card .date{color:var(--muted);font-size:12px;margin-bottom:6px}
    .card .gallery{display:flex;gap:8px;flex-wrap:wrap}
    .card .gallery img{width:100%;max-height:300px;object-fit:cover;border-radius:12px;border:1px solid rgba(148,163,184,.12)}
    .card .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tag{display:inline-block;padding:6px 10px;border:1px solid rgba(148,163,184,.2);border-radius:999px;color:var(--text);background:#0e1628;font-size:12px}
    .close{position:absolute;top:8px;right:8px;background:#0e1628;border:1px solid rgba(148,163,184,.2);border-radius:8px;color:var(--text);padding:4px 8px}

    /* Zoom UI */
    .zoom-ui{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:8px;z-index:60}
    .zoom-ui button{background:#0e1628;border:1px solid rgba(148,163,184,.25);color:var(--text);padding:10px 12px;border-radius:10px;box-shadow:var(--shadow)}

    /* Responsive */
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr}
      .legend{position:static;display:flex;gap:12px;width:auto;padding:8px 16px}
      .card{min-width:92vw;max-width:92vw}
    }
  </style>
</head>
<body>
  <header class="toolbar">
    <div class="bar">
      <div class="brand"><div class="mark">⚡</div><div>onlyfallout<span style="color:var(--accent)">.com</span></div></div>

      <div class="filters" id="filters">
        <!-- Games -->
        <div class="group" id="gamesGroup">
          <span class="label">Games:</span>
          <!-- checkboxes injected here -->
        </div>
        <!-- Factions -->
        <div class="group" id="factionsGroup">
          <span class="label">Factions:</span>
          <!-- checkboxes injected here -->
        </div>
        <!-- Search -->
        <label class="search" title="Search title, details, factions, keywords, games">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-4.3-4.3" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#94a3b8" stroke-width="2"/></svg>
          <input id="q" placeholder="Search the wasteland…" />
        </label>
        <button class="btn" id="clearBtn">Clear</button>
      </div>

      <div class="count" id="count">0 events</div>
    </div>
  </header>

  <main class="wrap">
    <aside class="legend" aria-label="Legend">
      <div style="margin-bottom:6px;color:#e2e8f0;font-weight:600">Legend</div>
      <div class="row"><span class="swatch" style="background:var(--pre)"></span> Pre‑War (≤ 2077‑10‑23)</div>
      <div class="row"><span class="swatch" style="background:var(--post)"></span> Post‑War (> 2077‑10‑23)</div>
      <div style="margin-top:10px;color:var(--muted)">Tip: Use <strong>+</strong>/<strong>−</strong>/<strong>0</strong> to zoom in/out/reset.</div>
    </aside>

    <section class="stage-wrap">
      <!-- Timeline lane and ticks are injected here -->
      <div id="lane" class="lane" aria-hidden="true"></div>
      <div id="stage" class="stage"></div>
    </section>
  </main>

  <div class="zoom-ui" aria-label="Zoom controls">
    <button id="zoomIn" title="Zoom in (+)">＋</button>
    <button id="zoomOut" title="Zoom out (−)">－</button>
    <button id="zoomReset" title="Reset (0)">⟳</button>
  </div>

  <footer style="max-width:1200px;margin:24px auto 40px;color:var(--muted);font-size:12px;padding:0 16px">
    © <span id="year"></span> onlyfallout.com — Fan‑made, unofficial. Fallout IP belongs to its owners.
  </footer>

  <script>
    // ====== Config ======
    const START = new Date('1900-01-01');
    const END   = new Date('3000-01-01');
    const CUTOFF = new Date('2077-10-23'); // Great War
    const DEFAULT_PX_PER_YEAR = 6; // not too tight, not too comfy
    const MIN_PX_PER_YEAR = 2;
    const MAX_PX_PER_YEAR = 18;
    const ZOOM_STEP = 1; // change per key/button press

    // Preferred order for game chips
    const GAME_ORDER = ['PRW','F1','F2','F3','FNV','F4','F76','TV','Non-canon'];

    // ====== State ======
    let EVENTS = [];
    let FILTER = { q: '', games: new Set(), factions: new Set() };
    let ACTIVE_ID = null;
    let PX_PER_YEAR = DEFAULT_PX_PER_YEAR;

    // ====== Elements ======
    const stage  = document.getElementById('stage');
    const laneEl = document.getElementById('lane');
    const qInput = document.getElementById('q');
    const clearBtn = document.getElementById('clearBtn');
    const countEl = document.getElementById('count');
    const gamesGroup = document.getElementById('gamesGroup');
    const factionsGroup = document.getElementById('factionsGroup');

    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const zoomResetBtn = document.getElementById('zoomReset');

    document.getElementById('year').textContent = new Date().getFullYear();

    // ====== Utils ======
    const yearsBetween = (a,b) => (b - a) / (1000*60*60*24*365.2425);
    const yForDate = (d) => Math.max(0, yearsBetween(START, d)) * PX_PER_YEAR;
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const asArray = v => Array.isArray(v) ? v : String(v||'').split(',').map(s=>s.trim()).filter(Boolean);

    function fmtDisplayDate(ev){
      if (ev.display_date) return ev.display_date;
      const d = new Date(ev.date);
      return d.toISOString().slice(0,10);
    }

    function getThumb(ev){
      const imgs = asArray(ev.images);
      if (imgs.length){ return imgs[0]; }
      return null;
    }

    function buildLane(totalH){
      laneEl.style.height = totalH + 'px';
      const preH = clamp(yForDate(CUTOFF), 0, totalH);
      laneEl.innerHTML = `<div class="seg" style="height:${preH}px;background:var(--pre)"></div>` +
                         `<div class="seg" style="height:${Math.max(0,totalH-preH)}px;background:var(--post)"></div>`;
    }

    function buildTicks(totalH){
      const startY = START.getUTCFullYear();
      const endY = END.getUTCFullYear();
      for(let y = Math.ceil(startY/10)*10; y <= endY; y += 10){
        const yPos = yForDate(new Date(`${y}-01-01T00:00:00Z`));
        const tick = document.createElement('div');
        tick.className = 'tick';
        tick.style.top = yPos + 'px';
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = y;
        tick.appendChild(label);
        stage.appendChild(tick);
      }
    }

    function passFilters(ev){
      const q = FILTER.q.trim().toLowerCase();
      if (q){
        const hay = [ev.title, ev.details, ...asArray(ev.keywords), ...asArray(ev.factions), ...asArray(ev.game)].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      if (FILTER.games.size){
        const gset = new Set(asArray(ev.game).map(s => s.toLowerCase()));
        let hit = false; FILTER.games.forEach(g => { if (gset.has(g)) hit = true; });
        if (!hit) return false;
      }
      if (FILTER.factions.size){
        const fset = new Set(asArray(ev.factions).map(s => s.toLowerCase()));
        let hit = false; FILTER.factions.forEach(f => { if (fset.has(f)) hit = true; });
        if (!hit) return false;
      }
      return true;
    }

    function clearStage(){ stage.innerHTML = ''; }

    function render(){
      clearStage();
      const totalH = Math.max(600, yForDate(END));
      stage.style.height = totalH + 'px';
      buildLane(totalH);
      buildTicks(totalH);

      const shown = EVENTS.filter(passFilters);
      countEl.textContent = `${shown.length} event${shown.length===1?'':'s'}`;

      // Render events and attach any open card
      shown.forEach((ev, i) => {
        const y = yForDate(new Date(ev.date));
        const el = document.createElement('button');
        el.className = 'event';
        el.style.top = y + 'px';
        const xShift = (i % 2) * 12; // slight stagger
        el.style.left = `calc(-28px + ${xShift}px)`; // keep spine a bit more to the left
        el.setAttribute('aria-label', ev.title || ev.id);
        el.addEventListener('click', () => openCard(ev.id, true));

        // thumbnail (blue-ish frame)
        const wrap = document.createElement('div');
        wrap.className = 'thumb-wrap';
        const src = getThumb(ev);
        let thumb;
        if (src){
          thumb = document.createElement('img');
          thumb.className = 'thumb';
          thumb.loading = 'lazy';
          thumb.alt = ev.title || ev.id;
          thumb.src = src;
        } else {
          thumb = document.createElement('div');
          thumb.className = 'thumb fallback';
          thumb.textContent = '？';
        }
        wrap.appendChild(thumb);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<div class="edate">${fmtDisplayDate(ev)}</div><div>${ev.title||''}</div>`;

        el.appendChild(wrap);
        el.appendChild(meta);
        stage.appendChild(el);

        if (ACTIVE_ID === ev.id){
          attachCard(ev, y, el);
        }
      });

      // Try to open hash after render
      if (location.hash && !ACTIVE_ID){
        const id = decodeURIComponent(location.hash.slice(1));
        if (EVENTS.find(e => e.id === id)) openCard(id, false);
      }
    }

    function attachCard(ev, y, anchorEl){
      // Remove existing
      const old = document.getElementById('openCard');
      if (old) old.remove();

      const card = document.createElement('div');
      card.className = 'card';
      card.id = 'openCard';

      // Position: to the RIGHT of the thumbnail box
      const anchorLeft = anchorEl.offsetLeft;
      const thumbWidth = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--thumb')) + 10; // wrap width
      const left = anchorLeft + thumbWidth + 16; // 16px gap to the right of thumb

      card.style.top = y + 'px';
      card.style.left = left + 'px';

      const imgs = asArray(ev.images);
      const parts = [];
      if (imgs.length){
        const first = imgs[0];
        const rest = imgs.slice(1);
        parts.push(`<div class="gallery">` +
          `<img src="${first}" alt="${ev.title||ev.id}" loading="lazy" />` +
          rest.map(src => `<img src="${src}" alt="${ev.title||ev.id}" loading="lazy" />`).join('') +
          `</div>`);
      }

      parts.push(`<button class="close" onclick="closeCard()" aria-label="Close">✕</button>`);
      parts.push(`<div class="title">${ev.title||ev.id}</div>`);
      parts.push(`<div class="date">${fmtDisplayDate(ev)} • ${ev.period==='pre-war'?'Pre‑War':'Post‑War'}${ev.canon==='non-canon'?' • Non‑canon':''}</div>`);

      if (ev.details){ parts.push(`<div style="margin:6px 0 10px">${escapeHTML(ev.details)}</div>`); }

      const chips = [];
      asArray(ev.keywords).forEach(k => chips.push(`<span class="tag">#${escapeHTML(k)}</span>`));
      asArray(ev.factions).forEach(f => chips.push(`<span class="tag">${escapeHTML(f)}</span>`));
      const orderedGames = asArray(ev.game).slice().sort((a,b)=>GAME_ORDER.indexOf(a) - GAME_ORDER.indexOf(b));
      orderedGames.forEach(g => chips.push(`<span class="tag">${escapeHTML(g)}</span>`));
      if (chips.length){ parts.push(`<div class="tags">${chips.join('')}</div>`); }

      // Related
      if (ev.related_ids && asArray(ev.related_ids).length){
        const rel = asArray(ev.related_ids).filter(rid => EVENTS.find(e => e.id === rid));
        if (rel.length){
          parts.push('<div style="margin-top:8px"><div style="color:var(--muted);font-size:12px;margin-bottom:6px">Related events</div>' +
            rel.map(rid => `<a class="tag" href="#${encodeURIComponent(rid)}" onclick="event.preventDefault(); openById('${encodeURIComponent(rid)}');">${escapeHTML(rid)}</a>`).join('') +
            '</div>');
        }
      }

      parts.push(`<div style="margin-top:10px"><button class="btn" onclick="copyLink('${encodeURIComponent(ev.id)}')">Copy link</button></div>`);

      card.innerHTML = parts.join('');
      stage.appendChild(card);
    }

    function openCard(id, updateHash){
      const ev = EVENTS.find(e => e.id === id);
      if (!ev) return;
      ACTIVE_ID = id;
      if (updateHash){ history.replaceState(null, '', `#${encodeURIComponent(id)}`); }
      const y = yForDate(new Date(ev.date));

      // find anchor element to compute left
      const anchors = [...stage.querySelectorAll('.event')];
      const anchorEl = anchors.find(btn => (btn.querySelector('.meta')?.textContent||'').includes(ev.title || '')) || anchors[0];
      attachCard(ev, y, anchorEl);
    }

    function closeCard(){
      ACTIVE_ID = null;
      const old = document.getElementById('openCard');
      if (old) old.remove();
      history.replaceState(null, '', location.pathname + location.search);
    }

    function openById(id){
      const rid = decodeURIComponent(id);
      const ev = EVENTS.find(e => e.id === rid);
      if (ev){
        const y = yForDate(new Date(ev.date));
        window.scrollTo({ top: Math.max(0, y - 140), behavior: 'smooth' });
        openCard(rid, true);
      }
    }

    function copyLink(id){
      const url = `${location.origin}${location.pathname}#${id}`;
      navigator.clipboard.writeText(url).then(()=>{ alert('Link copied to clipboard'); });
    }

    function escapeHTML(s){
      return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // ====== Filters UI (checkboxes) ======
    function uniqueValues(collector){
      const set = new Set();
      EVENTS.forEach(ev => collector(ev).forEach(v => set.add(v)));
      return Array.from(set);
    }

    function renderFilterCheckboxes(){
      // Games
      const allGames = uniqueValues(ev => asArray(ev.game)).sort((a,b)=>{
        const ia = GAME_ORDER.indexOf(a), ib = GAME_ORDER.indexOf(b);
        return (ia===-1?999:ia) - (ib===-1?999:ib);
      });
      gamesGroup.querySelectorAll('label.checkbox').forEach(n=>n.remove());
      allGames.forEach(g => {
        const id = `g_${g.replace(/[^a-z0-9]/gi,'_')}`;
        const lbl = document.createElement('label');
        lbl.className = 'checkbox';
        lbl.innerHTML = `<input type="checkbox" id="${id}"> <span>${g}</span>`;
        const cb = lbl.querySelector('input');
        cb.addEventListener('change', () => {
          if (cb.checked) FILTER.games.add(g.toLowerCase()); else FILTER.games.delete(g.toLowerCase());
          render();
        });
        gamesGroup.appendChild(lbl);
      });

      // Factions
      const allFactions = uniqueValues(ev => asArray(ev.factions)).sort((a,b)=>a.localeCompare(b));
      factionsGroup.querySelectorAll('label.checkbox').forEach(n=>n.remove());
      allFactions.forEach(f => {
        const id = `f_${f.replace(/[^a-z0-9]/gi,'_')}`;
        const lbl = document.createElement('label');
        lbl.className = 'checkbox';
        lbl.innerHTML = `<input type="checkbox" id="${id}"> <span>${f}</span>`;
        const cb = lbl.querySelector('input');
        cb.addEventListener('change', () => {
          if (cb.checked) FILTER.factions.add(f.toLowerCase()); else FILTER.factions.delete(f.toLowerCase());
          render();
        });
        factionsGroup.appendChild(lbl);
      });
    }

    // ====== Search/clear wiring ======
    qInput.addEventListener('input', () => { FILTER.q = qInput.value; render(); });
    clearBtn.addEventListener('click', () => {
      FILTER = { q: '', games: new Set(), factions: new Set() };
      qInput.value='';
      gamesGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      factionsGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      render();
    });

    // ====== Zoom controls ======
    function setZoom(val){
      PX_PER_YEAR = clamp(val, MIN_PX_PER_YEAR, MAX_PX_PER_YEAR);
      render();
    }
    zoomInBtn.addEventListener('click', () => setZoom(PX_PER_YEAR + ZOOM_STEP));
    zoomOutBtn.addEventListener('click', () => setZoom(PX_PER_YEAR - ZOOM_STEP));
    zoomResetBtn.addEventListener('click', () => setZoom(DEFAULT_PX_PER_YEAR));

    // Keyboard shortcuts (+, -, 0), ignore when typing in inputs or with Ctrl/Cmd
    window.addEventListener('keydown', (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
      if (tag === 'input' || tag === 'textarea' || e.ctrlKey || e.metaKey || e.altKey) return;
      if (e.key === '+' || e.key === '='){ e.preventDefault(); setZoom(PX_PER_YEAR + ZOOM_STEP); }
      else if (e.key === '-' || e.key === '_'){ e.preventDefault(); setZoom(PX_PER_YEAR - ZOOM_STEP); }
      else if (e.key === '0'){ e.preventDefault(); setZoom(DEFAULT_PX_PER_YEAR); }
      else if (e.key === 'Escape'){ closeCard(); }
    });

    // Click outside to close card
    document.addEventListener('click', (e) => {
      const card = document.getElementById('openCard');
      if (!card) return;
      const within = card.contains(e.target) || (e.target.closest && e.target.closest('.event'));
      if (!within) closeCard();
    });

    // ====== Boot ======
    fetch('/events.json', { cache: 'no-cache' })
      .then(r => r.json())
      .then(data => {
        EVENTS = (data||[]).map(ev => ({
          ...ev,
          game: asArray(ev.game),
          factions: asArray(ev.factions),
          keywords: asArray(ev.keywords),
          images: asArray(ev.images),
          related_ids: asArray(ev.related_ids),
        }));
        EVENTS.sort((a,b) => a.date.localeCompare(b.date));
        renderFilterCheckboxes();
        render();
        if (location.hash){
          const id = decodeURIComponent(location.hash.slice(1));
          if (EVENTS.find(e => e.id === id)) openCard(id, false);
        }
      })
      .catch(err => {
        console.error('Failed to load events.json', err);
        stage.innerHTML = '<div style="padding:20px;color:var(--muted)">Could not load events. Make sure <code>events.json</code> is in your repo root.</div>';
      });

    // Hash navigation
    window.addEventListener('hashchange', () => {
      const id = decodeURIComponent(location.hash.slice(1));
      if (id) openCard(id, false);
    });
  </script>
</body>
</html>
